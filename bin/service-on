#!/bin/sh
BIN_DIR="$(dirname "$0")"
PAK_DIR="$(dirname "$BIN_DIR")"
PAK_NAME="$(basename "$PAK_DIR")"
PAK_NAME="${PAK_NAME%.*}"

# Enable debug output
set -x

echo "=== service-on starting ==="
echo "$0" "$@"
cd "$PAK_DIR" || exit 1

MODULE_NAME="poweroff_hook"
MODULE_PATH="$PAK_DIR/bin/poweroff_hook.ko"

main() {
    echo "Checking for module at: $MODULE_PATH"
    if [ ! -f "$MODULE_PATH" ]; then
        echo "ERROR: Module not found at $MODULE_PATH"
        ls -lh "$PAK_DIR/bin/" || true
        return 1
    fi
    
    echo "Module file found, size: $(ls -lh "$MODULE_PATH" | awk '{print $5}')"
    
    # Check if module is already loaded
    if lsmod | grep -q "^$MODULE_NAME "; then
        echo "Module $MODULE_NAME is already loaded"
        return 0
    fi
    
    # Load the kernel module
    echo "Attempting to load module: insmod $MODULE_PATH"
    insmod "$MODULE_PATH" 2>&1
    ret=$?
    
    if [ $ret -eq 0 ]; then
        echo "SUCCESS: Module $MODULE_NAME loaded (exit code: 0)"
        lsmod | grep "$MODULE_NAME" || true
        return 0
    else
        echo "ERROR: Failed to load module $MODULE_NAME (exit code: $ret)"
        echo "Module path: $MODULE_PATH"
        echo "===== Last 20 kernel messages ====="
        dmesg | tail -20
        echo "===== End kernel messages ====="
        return 1
    fi
}

main "$@"
